<!DOCTYPE HTML>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>漢字でにゃんこ大戦争</title>
<link rel="apple-touch-icon" href="img/icon.jpg">
<style>
body {
    margin: 0;
    font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", sans-serif;
    background: url('img/kabe.jpg') no-repeat center center fixed;
    background-size: cover;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    overflow-x: hidden;
}
h1 {
    font-size: 2.6em;
    color: #fff;
    text-shadow: 3px 3px #000;
    margin-top: 10px;
}
#groupSelect, #gameScreen, #resultsScreen {
    text-align: center;
    width: 100%;
    max-width: 900px;
    padding: 10px;
}
#groupSelect p, #resultsScreen h2, #question, .result-item p {
    color: #fff;
    text-shadow: 3px 3px #000;
}
.group-button, #nextButton, #restartButton, #clearButton {
    font-size: 1.5em;
    padding: 12px 24px;
    margin: 10px;
    width: auto;
    min-width: 200px;
    border-radius: 15px;
    border: none;
    background-color: #fff799;
    cursor: pointer;
    transition: transform 0.1s, background 0.2s;
    white-space: nowrap;
}
.group-button:hover, #nextButton:hover, #restartButton:hover, #clearButton:hover {
    background-color: #ffe66d;
    transform: translateY(-2px);
}
#clearButton:disabled {
    background-color: #ddd;
    cursor: not-allowed;
    transform: none;
}
@media (max-width: 600px) {
    .group-button, #nextButton, #restartButton, #clearButton {
        width: 80%;
        white-space: normal;
    }
}
#question {
    font-size: 2em;
    font-weight: bold;
    margin: 10px 0;
    min-height: 50px;
    background-color: transparent;
    padding: 8px 12px;
    border-radius: 8px;
}
#drawCanvas {
    border: 2px solid #000;
    display: block;
    margin: 10px auto;
    background-color: #fff;
    touch-action: none;
    width: 90%;
    height: 50vh;
    max-width: 700px;
    border-radius: 10px;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
}
#results {
    text-align: left;
    padding: 10px;
    font-size: 1.2em;
}
.result-item {
    margin-bottom: 20px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 10px;
}
.result-item img {
    background-color: #fff;
    border: 1px solid #ddd;
    width: 100%;
}
#nekoTeacher {
    position: fixed;
    bottom: 10px;
    right: 5%;
    width: 120px;
    z-index: 10;
    animation: neko-bounce 2s infinite ease-in-out;
}
@keyframes neko-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}
@media (orientation: landscape) {
    h1 { font-size: 2.8em; }
    #drawCanvas { height: 45vh; }
    #nekoTeacher { width: 100px; }
}

/* ========== アニメーション用レイヤー ========== */
#animationLayer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    overflow: visible;
    z-index: 50;
}
.character {
    position: absolute;
    width: 60px;
}
</style>
</head>

<body>
<h1>漢字でにゃんこ大戦争</h1>

<div id="groupSelect">
    <p>学習するグループを選ぼう！</p>
    <div id="groupButtons"></div>
</div>

<div id="gameScreen" style="display:none;">
    <div id="question">練習開始！</div>
    <canvas id="drawCanvas"></canvas>
    <div>
        <button id="nextButton">次へ（クリックして開始）</button>
        <button id="clearButton" disabled>消去</button>
    </div>
</div>

<div id="resultsScreen" style="display:none;">
    <h2>結果一覧</h2>
    <div id="results"></div>
    <button id="restartButton">スタートに戻る</button>
</div>

<img src="img/neko.png" id="nekoTeacher" alt="ねこ先生">

<!-- アニメーション用レイヤー -->
<div id="animationLayer"></div>

<script>
/*============ グループデータ ============*/
const groups = {
"1-1": [["「いち」ねんせい", "一"], ["「みぎ」をむく", "右"], ["「あめ」がふる", "雨"], ["ひゃく「えん」だま", "円"], ["「おう」さま", "王"], ["「おと」がきこえる", "音"], ["「した」をむく", "下"], ["「ひ」あそび", "火"], ["「はな」をうえる", "花"], ["「かい」をひろう", "貝"]],
"1-2": [["さんすうを「まな」ぶ", "学"], ["くう「き」をすう", "気"], ["「きゅう」にん", "九"], ["「やす」む", "休"], ["「たま」がころがる", "玉"], ["「きん」をほる", "金"], ["「そら」があおい", "空"], ["「つき」がでる", "月"], ["「いぬ」がほえる", "犬"], ["テレビを「み」る", "見"]],
"1-3": [["「ご」にん", "五"], ["「くち」をあける", "口"], ["がっ「こう」", "校"], ["「ひだり」をむく", "左"], ["ぼく「さん」さい", "三"], ["「やま」にのぼる", "山"], ["「こ」ども", "子"], ["わたし「よん」さい", "四"], ["「いと」をむすぶ", "糸"], ["「じ」をかく", "字"]],
"1-4": [["「みみ」でおとをきく", "耳"], ["いま「しち」じ", "七"], ["「くるま」にのる", "車"], ["「て」をあらう", "手"], ["「じゅう」じか", "十"], ["「で」かける", "出"], ["「おんな」のこ", "女"], ["「ちいさ」い", "小"], ["「うえ」をみる", "上"], ["「もり」にいく", "森"]],
"1-5": [["「ひと」があつまる", "人"], ["「みず」をのむ", "水"], ["「ただ」しいこたえ", "正"], ["「い」きる", "生"], ["「あお」いそら", "青"], ["「ゆう」がた", "夕"], ["「いし」をひろう", "石"], ["「あか」いふく", "赤"], ["「せん」えんさつ", "千"], ["「かわ」であそぶ", "川"]],
"1-6": [["「さき」にすすむ", "先"], ["「はや」くおきる", "早"], ["「くさ」がのびる", "草"], ["「あし」をあらう", "足"], ["「むら」にすむ", "村"], ["「おお」きいいぬ", "大"], ["「おとこ」のこ", "男"], ["「たけ」のこ", "竹"], ["「なか」にはいる", "中"], ["「むし」をみつける", "虫"]],
"1-7": [["「まち」をあるく", "町"], ["「てん」きがいい", "天"], ["「た」んぼ", "田"], ["「つち」をさわる", "土"], ["「ふた」つ", "二"], ["「ひ」がのぼる", "日"], ["「はい」る", "入"], ["「とし」をとる", "年"], ["「しろ」いねこ", "白"], ["「はち」ひき", "八"]],
"1-8": [["「ひゃく」えん", "百"], ["「ぶん」をよむ", "文"], ["「き」にのぼる", "木"], ["「ほん」をよむ", "本"], ["「な」まえをかく", "名"], ["「め」をとじる", "目"], ["にほんあしで「た」つ", "立"], ["「ちから」をいれる", "力"], ["「はやし」にいく", "林"], ["「ろく」さい", "六"]]
};

/*============ 状態管理 ============*/
let currentGroup = [];
let questionHistory = [];
let savedDrawings = [];
let i = 0, t = 0;
let drawingEnabled = true;
let isDrawing = false;

/*============ キャンバス描画 ============*/
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
ctx.lineWidth = 5;
ctx.strokeStyle = '#000';

function getPoint(e) {
    const rect = canvas.getBoundingClientRect();
    let clientX, clientY;
    if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
    } else {
        clientX = e.clientX;
        clientY = e.clientY;
    }
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}
function startDrawing(e){ if(!drawingEnabled)return; e.preventDefault(); isDrawing=true; const {x,y}=getPoint(e); ctx.beginPath(); ctx.moveTo(x,y);}
function draw(e){ if(!isDrawing||!drawingEnabled)return; e.preventDefault(); const {x,y}=getPoint(e); ctx.lineTo(x,y); ctx.stroke();}
function stopDrawing(){ isDrawing=false; ctx.closePath();}
function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height);}
function saveCanvasImage(){
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.fillStyle = '#fff';
    tempCtx.fillRect(0,0,tempCanvas.width,tempCanvas.height);
    tempCtx.drawImage(canvas,0,0);
    return tempCanvas.toDataURL();
}

canvas.addEventListener('mousedown',startDrawing);
canvas.addEventListener('mousemove',draw);
canvas.addEventListener('mouseup',stopDrawing);
canvas.addEventListener('mouseleave',stopDrawing);
canvas.addEventListener('touchstart',startDrawing);
canvas.addEventListener('touchmove',draw);
canvas.addEventListener('touchend',stopDrawing);

/*============ ゲーム制御 ============*/
function startGroup(key){
    currentGroup = shuffle([...groups[key]]);
    i=0; t=0;
    questionHistory=[]; savedDrawings=[];
    drawingEnabled=true;
    clearCanvas();
    document.getElementById('groupSelect').style.display='none';
    document.getElementById('resultsScreen').style.display='none';
    document.getElementById('gameScreen').style.display='block';
    document.getElementById('nextButton').textContent="次へ（クリックして開始）";
    document.getElementById('nextButton').onclick = change;
    document.getElementById('clearButton').disabled = true;
    document.getElementById('question').textContent="練習開始！";
}

function change(){
    const Q=document.getElementById('question');
    const clearBtn=document.getElementById('clearButton');

    if(i>=10 && t===0){
        Q.textContent="全問終了！結果を確認してね。";
        document.getElementById('nextButton').textContent="結果を見る";
        document.getElementById('nextButton').onclick=endGame;
        clearBtn.disabled=true;
        return;
    }

    if(t===0){
        if(i>0)savedDrawings.push(saveCanvasImage());
        clearCanvas(); drawingEnabled=true;
        const [q,a]=currentGroup[i];
        Q.textContent=`問${i+1}: ${q}`;
        questionHistory.push({question:q,answer:a});
        document.getElementById('nextButton').textContent="解答へ";
        clearBtn.disabled=false;
        t=1;

        if(Math.random()<0.5){ showRandomCharacter(); }

    } else {
        drawingEnabled=false;
        Q.textContent=`問${i+1}: ${currentGroup[i][1]}`;
        document.getElementById('nextButton').textContent=(i<9)?"次の問題へ":"結果を見る";
        clearBtn.disabled=true;
        t=0; i++;
    }
}

function endGame(){
    savedDrawings.push(saveCanvasImage());
    document.getElementById('gameScreen').style.display='none';
    document.getElementById('resultsScreen').style.display='block';
    const results=document.getElementById('results');
    results.innerHTML='';
    questionHistory.forEach((h,idx)=>{
        const div=document.createElement('div');
        div.className='result-item';
        div.innerHTML=`<p><strong>問${idx+1}:</strong> ${h.question} → <strong>${h.answer}</strong></p>`;
        const img=document.createElement('img');
        img.src=savedDrawings[idx];
        div.appendChild(img);
        results.appendChild(div);
    });
}
document.getElementById('restartButton').onclick=()=>{
    i=0;t=0;questionHistory=[];savedDrawings=[];
    document.getElementById('resultsScreen').style.display='none';
    document.getElementById('groupSelect').style.display='block';
    clearCanvas();
};

/*============ 消去ボタン機能 ============*/
document.getElementById('clearButton').onclick=()=>{ if(!drawingEnabled)return; clearCanvas(); };

/*============ ユーティリティ ============*/
function shuffle(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } return array; }
const btnArea=document.getElementById('groupButtons');
Object.keys(groups).forEach(k=>{
    const btn=document.createElement('button');
    btn.textContent=k;
    btn.className='group-button';
    btn.onclick=()=>startGroup(k);
    btnArea.appendChild(btn);
});

/*============ requestAnimationFrame でキャラクター演出 ============*/
function showRandomCharacter(){
    const chars=["neko1.png","neko2.png","neko3.png","neko4.png"];
    const img = document.createElement('img');
    img.src="img/"+chars[Math.floor(Math.random()*chars.length)];
    img.className="character";
    const layer = document.getElementById('animationLayer');
    layer.appendChild(img);

    // 初期位置ランダム
    let x = Math.random() * (window.innerWidth - 60);
    let y = Math.random() * (window.innerHeight - 60);
    let dx = (Math.random()-0.5)*4; // 横移動速度
    let dy = (Math.random()-0.5)*4; // 縦移動速度
    let rotation = 0;
    let dRotation = (Math.random()-0.5)*0.2;

    function animate(){
        x += dx;
        y += dy;
        rotation += dRotation;

        img.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}rad)`;

        if(x<-100 || x>window.innerWidth+100 || y<-100 || y>window.innerHeight+100){
            img.remove();
            return;
        }
        requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
}
</script>
</body>
</html>
